---
- name: Ensure PHPBrew is present.
  get_url:
    url: https://github.com/phpbrew/phpbrew/raw/master/phpbrew
    mode: "0755"
    dest: ~/bin/phpbrew
  register: phpbrew

- name: Ensure PHPBrew is initialized.
  shell: phpbrew init
  args:
    creates: ~/.phpbrew/init

- name: Ensure PHPBrew is updated.
  shell: phpbrew self-update

- name: Ensure PHPBrew known versions are updated.
  shell: phpbrew update

- name: Ensure build environment is set.
  include: setup-Darwin.yml
  when: ansible_os_family == "Darwin"

- name: Ensure PHP {{ phpbrew_php_version }} is the present.
  shell: phpbrew install {{ phpbrew_php_version }} +default +fpm -- --with-openssl=/usr/local/opt/openssl --with-zlib-dir=/usr/local/opt/zlib --without-bz2
  args:
    creates: ~/.phpbrew/php/php-{{ phpbrew_php_version }}

- name: Ensure Composer is present.
  shell: curl -sS https://getcomposer.org/installer | (source ~/.phpbrew/bashrc && php)
  args:
    chdir: ~/bin
    creates: ~/bin/composer.phar

- name: Ensure Composer is updated.
  shell: composer.phar self-update
